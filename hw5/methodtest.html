<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTTP with JavaScript</title>
  <link rel="icon" href="/assets/images/logo.svg" />
  <link rel="stylesheet" href="/assets/styles/index.css" />
</head>
<body>
  <header>
    <nav>
      <ul class="site-nav">
        <li>
          <a href="/pages/about.html">About</a>
        </li>
        <li>
          <a href="/pages/projects/projects.html">Projects</a>
        </li>
        <li>
          <a href="/index.html" class="logo-link">
            <img src="/assets/images/logo.svg" alt="Home" class="logo" />
          </a>
        </li>
        <li>
          <a href="/pages/wip/wip.html">WIP</a>
        </li>
        <li>
          <a href="/pages/contact.html">Contact</a>
        </li>
        <li>
          <a href="/hw5/methodtest.html">HTTP with JS</a>
        </li>
        <li>
          <a href="/hw5/webcomponent.html">Simple Web Component</a>
        </li>
      </ul>
    </nav>
  </header>
  <main>
    <p>Fill out the following fields and select an HTTP method.</p>
    <form id="form">
      <label for="id">Record ID</label>
      <input type="number" id="id" name="id" />

      <label for="article_name">Article Name</label>
      <input type="text" id="article_name" name="article_name" />

      <label for="article_body">Article Content</label>
      <textarea id="article_body" name="article_body"></textarea>

      <input type="hidden" id="date" name="date" />

      <button type="button" id="postBtn">Post</button>
      <button type="button" id="getBtn">Get</button>
      <button type="button" id="putBtn">Put</button>
      <button type="button" id="deleteBtn">Delete</button>
    </form>
    <output id="response"></output>
  </main>
  <footer>
    <address>
      <ul class="socials">
        <li>
          <a href="https://github.com/sdchin">
            <img
              src="/assets/images/github-mark.svg"
              alt="Visit GitHub profile"
              height="35"
              loading="lazy"
            />
          </a>
        </li>
        <li>
          <a href="https://linkedin.com/in/sdchin">
            <img
              src="/assets/images/LI-In-Bug.png"
              alt="Visit LinkedIn profile"
              height="35"
              loading="lazy"
            />
          </a>
        </li>
      </ul>
    </address>
    <small>Made with <span lang="yue">æ„›</span></small>
  </footer>
  <script>
    async function sendRequest(e) {
      let form = document.getElementById('form');
      let date = new Date().toISOString();
      form.querySelector('#date').value = date;

      let formData = new FormData(form);
      let body = new URLSearchParams(formData).toString();
      let qString = body;
      
      let action;
      let method;
      switch (e.target.id) {
        case 'postBtn':
          action = 'https://httpbin.org/post';
          method =  'POST';
          break;
        case 'getBtn':
          action = `https://httpbin.org/get?${qString}`;
          method = 'GET';
          break;
        case 'putBtn':
          action = 'https://httpbin.org/put';
          method = 'PUT';
          break;
        case 'deleteBtn':
          action = `https://httpbin.org/delete?${qString}`;
          method = 'DELETE';
          break;
        default:
          console.log("Error: Cannot send request.");
          break;
      }
      
      let options = (e.target.id === 'getBtn' || e.target.id === 'deleteBtn') ? {method} : {method, body};
      let resp = await fetch(action, options);
      if (!resp.ok) {
        console.log(resp);
        return {};
      }

      const data = await resp.json();
      console.log(data);
      const string = JSON.stringify(data, null, '\t');
      console.log(string);
      return data;
    }

    function helper(obj, key, indent) {
      const output = document.getElementById('response');

      if (!(typeof obj[key] === 'object')) {
        const markup = document.createElement('pre');
        markup.innerHTML = `${`\t`.repeat(indent)}${key}: ${obj[key]}`;
        output.append(markup);
        return;
      }

      const markup = document.createElement('pre');
      markup.innerHTML = `${`\t`.repeat(indent)}${key}:`;
      output.append(markup);

      for (const k in obj[key]) {
        helper(obj[key], k, indent + 1);
      }
    }

    function render(json) {
      const output = document.getElementById('response');
      output.innerHTML = '';

      for (const key in json) {
        helper(json, key, 0);
      }
    }

    const postBtn = document.getElementById('postBtn');
    const getBtn = document.getElementById('getBtn');
    const putBtn = document.getElementById('putBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    postBtn.addEventListener('click', async (e) => {
      render(await sendRequest(e));
    });
    getBtn.addEventListener('click', async (e) => {
      render(await sendRequest(e));
    });
    putBtn.addEventListener('click', async (e) => {
      render(await sendRequest(e));
    });
    deleteBtn.addEventListener('click', async (e) => {
      render(await sendRequest(e));
    });
  </script>
</body>
</html>